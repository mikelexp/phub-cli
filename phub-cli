#!/usr/bin/env bash

exec </dev/tty

# Resolve script directory (handles symlinks)
SCRIPT="$0"
while [ -L "$SCRIPT" ]; do
    SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT")" && pwd)"
    SCRIPT="$(readlink "$SCRIPT")"
    [[ "$SCRIPT" != /* ]] && SCRIPT="$SCRIPT_DIR/$SCRIPT"
done
DIR="$(cd -P "$(dirname "$SCRIPT")" && pwd)"

source "$DIR/modules/categories.sh"
source "$DIR/modules/player.sh"
source "$DIR/modules/ui.sh"

command -v fzf >/dev/null || { echo "fzf not installed"; exit 1; }
command -v mpv >/dev/null || { echo "mpv not installed"; exit 1; }
command -v yt-dlp >/dev/null || { echo "yt-dlp not installed"; exit 1; }

while true; do
    clear
    show_home

    choice=$(printf "%s\n" \
        "browse|Browse categories" \
        "search|Search videos" \
        "channels|Search by channel" \
        "quit|Quit" \
        | fzf \
            --prompt="Home ❯ " \
            --height=100% \
            --border \
            --layout=reverse \
            --cycle \
            --delimiter="|" \
            --with-nth=2 \
        | awk -F'|' '{print $1}')

    # ESC in home menu = quit
    [ -z "$choice" ] && choice="quit"

    case "$choice" in

    #categ
    browse)
        category=$(get_categories | fzf \
            --prompt="Category ❯ " \
            --height=100% \
            --border \
            --layout=reverse \
            --cycle \
            --delimiter="|" \
            --with-nth=2)

        [ -z "$category" ] && continue

        cid=$(echo "$category" | awk -F'|' '{print $1}')
        category_name=$(echo "$category" | awk -F'|' '{print $2}')
        page=1

        #res
        while true; do
            # Build list with pagination
            video_list=$("$DIR/modules/videos.py" "$cid" "$page")

            # Add navigation options
            nav_options=""
            [ "$page" -gt 1 ] && nav_options="PREV|<<< Previous page\n"
            nav_options="${nav_options}NEXT|>>> Next page"

            video=$(printf "%s\n%b" "$video_list" "$nav_options" | fzf \
                --prompt="$category_name (page $page) ❯ " \
                --height=100% \
                --border \
                --layout=reverse \
                --cycle \
                --delimiter="|" \
                --with-nth=2 \
                --preview='echo {} | cut -d"|" -f2' \
                --preview-window=down:4:wrap)

            [ -z "$video" ] && break

            viewkey=$(echo "$video" | awk -F'|' '{print $1}')
            video_title=$(echo "$video" | awk -F'|' '{print $2}')

            # Handle pagination
            if [ "$viewkey" = "NEXT" ]; then
                ((page++))
                continue
            elif [ "$viewkey" = "PREV" ]; then
                ((page--))
                [ "$page" -lt 1 ] && page=1
                continue
            fi

            #pre-play menu
            while true; do
                clear
                pre_action=$(pre_play_menu "$video_title")
                [ -z "$pre_action" ] && break

                case "$pre_action" in
                    watch)
                        # Watch video
                        play_video "$viewkey"
                        # Return to pre-play menu (clear will be done by loop)
                        continue
                        ;;
                    download)
                        # Download video
                        clear
                        quality=$(quality_menu "$video_title")
                        [ -z "$quality" ] && continue

                        case "$quality" in
                            1|2|3|4)
                                download_video "$viewkey" "$quality"
                                # Return to pre-play menu
                                continue
                                ;;
                            back)
                                continue
                                ;;
                            home)
                                nav="home"
                                break
                                ;;
                            quit)
                                clear
                                exit 0
                                ;;
                            *)
                                continue
                                ;;
                        esac
                        ;;
                    browser)
                        # Open in browser
                        open_in_browser "$viewkey"
                        continue
                        ;;
                    back)
                        break
                        ;;
                    *)
                        continue
                        ;;
                esac
            done

            #back
            if [ "$nav" = "home" ]; then
                nav=""
                break
            fi
        done
        ;;

    #Search
    search)
        read -r -p "Search query: " query </dev/tty
        [ -z "$query" ] && continue
        page=1

        while true; do
            # Build list with pagination
            video_list=$("$DIR/modules/search.py" "$query" "$page")

            # Add navigation options
            nav_options=""
            [ "$page" -gt 1 ] && nav_options="PREV|<<< Previous page\n"
            nav_options="${nav_options}NEXT|>>> Next page"

            video=$(printf "%s\n%b" "$video_list" "$nav_options" | fzf \
                --prompt="Search: $query (page $page) ❯ " \
                --height=100% \
                --border \
                --layout=reverse \
                --cycle \
                --delimiter="|" \
                --with-nth=2 \
                --preview='echo {} | cut -d"|" -f2' \
                --preview-window=down:4:wrap)

            [ -z "$video" ] && break

            viewkey=$(echo "$video" | awk -F'|' '{print $1}')
            video_title=$(echo "$video" | awk -F'|' '{print $2}')

            # Handle pagination
            if [ "$viewkey" = "NEXT" ]; then
                ((page++))
                continue
            elif [ "$viewkey" = "PREV" ]; then
                ((page--))
                [ "$page" -lt 1 ] && page=1
                continue
            fi

            #pre-play menu
            while true; do
                clear
                pre_action=$(pre_play_menu "$video_title")
                [ -z "$pre_action" ] && break

                case "$pre_action" in
                    watch)
                        # Watch video
                        play_video "$viewkey"
                        # Return to pre-play menu (clear will be done by loop)
                        continue
                        ;;
                    download)
                        # Download video
                        clear
                        quality=$(quality_menu "$video_title")
                        [ -z "$quality" ] && continue

                        case "$quality" in
                            1|2|3|4)
                                download_video "$viewkey" "$quality"
                                # Return to pre-play menu
                                continue
                                ;;
                            back)
                                continue
                                ;;
                            home)
                                nav="home"
                                break
                                ;;
                            quit)
                                clear
                                exit 0
                                ;;
                            *)
                                continue
                                ;;
                        esac
                        ;;
                    browser)
                        # Open in browser
                        open_in_browser "$viewkey"
                        continue
                        ;;
                    back)
                        break
                        ;;
                    home)
                        nav="home"
                        break
                        ;;
                    quit)
                        clear
                        exit 0
                        ;;
                    *)
                        continue
                        ;;
                esac
            done

            if [ "$nav" = "home" ]; then
                nav=""
                break
            fi
        done
        ;;

    #Channels
    channels)
        read -r -p "Search channels: " query </dev/tty
        [ -z "$query" ] && continue

        # List channels
        channel=$("$DIR/modules/channels.py" "$query" | fzf \
            --prompt="Channel ❯ " \
            --height=100% \
            --border \
            --layout=reverse \
            --cycle \
            --delimiter="|" \
            --with-nth=2)

        [ -z "$channel" ] && continue

        channel_name=$(echo "$channel" | awk -F'|' '{print $1}')
        channel_title=$(echo "$channel" | awk -F'|' '{print $2}')
        page=1

        while true; do
            # Build list with pagination
            video_list=$("$DIR/modules/channel_videos.py" "$channel_name" "$page")

            # Add navigation options
            nav_options=""
            [ "$page" -gt 1 ] && nav_options="PREV|<<< Previous page\n"
            nav_options="${nav_options}NEXT|>>> Next page"

            video=$(printf "%s\n%b" "$video_list" "$nav_options" | fzf \
                --prompt="$channel_title (page $page) ❯ " \
                --height=100% \
                --border \
                --layout=reverse \
                --cycle \
                --delimiter="|" \
                --with-nth=2 \
                --preview='echo {} | cut -d"|" -f2' \
                --preview-window=down:4:wrap)

            [ -z "$video" ] && break

            viewkey=$(echo "$video" | awk -F'|' '{print $1}')
            video_title=$(echo "$video" | awk -F'|' '{print $2}')

            # Handle pagination
            if [ "$viewkey" = "NEXT" ]; then
                ((page++))
                continue
            elif [ "$viewkey" = "PREV" ]; then
                ((page--))
                [ "$page" -lt 1 ] && page=1
                continue
            fi

            #pre-play menu
            while true; do
                clear
                pre_action=$(pre_play_menu "$video_title" "$channel_title")
                [ -z "$pre_action" ] && break

                case "$pre_action" in
                    watch)
                        # Watch video
                        play_video "$viewkey"
                        # Return to pre-play menu (clear will be done by loop)
                        continue
                        ;;
                    download)
                        # Download video
                        while true; do
                            clear
                            quality=$(quality_menu "$video_title" "$channel_title")
                            [ -z "$quality" ] && break

                            case "$quality" in
                                1|2|3|4)
                                    if download_video "$viewkey" "$quality"; then
                                        clear
                                        dl_action=$(post_download_menu "$video_title" "$channel_title")
                                        [ -z "$dl_action" ] && break

                                        case "$dl_action" in
                                            another)
                                                continue
                                                ;;
                                            results)
                                                break
                                                ;;
                                            home)
                                                nav="home"
                                                break
                                                ;;
                                            quit)
                                                clear
                                                exit 0
                                                ;;
                                            *)
                                                continue
                                                ;;
                                        esac
                                    else
                                        break
                                    fi
                                    ;;
                                back)
                                    break
                                    ;;
                                home)
                                    nav="home"
                                    break
                                    ;;
                                quit)
                                    clear
                                    exit 0
                                    ;;
                                *)
                                    continue
                                    ;;
                            esac
                        done
                        [ "$nav" = "home" ] && break
                        break
                        ;;
                    browser)
                        # Open in browser
                        open_in_browser "$viewkey"
                        continue
                        ;;
                    back)
                        break
                        ;;
                    home)
                        nav="home"
                        break
                        ;;
                    quit)
                        clear
                        exit 0
                        ;;
                    *)
                        continue
                        ;;
                esac
            done

            if [ "$nav" = "home" ]; then
                nav=""
                break
            fi
        done
        ;;

    #Quit
    quit)
        clear
        exit 0
        ;;

    *)
        continue
        ;;
    esac
done
