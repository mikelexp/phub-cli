#!/usr/bin/env bash

exec </dev/tty

DIR="$(cd "$(dirname "$0")" && pwd)"

source "$DIR/modules/categories.sh"
source "$DIR/modules/player.sh"
source "$DIR/modules/ui.sh"

command -v fzf >/dev/null || { echo "fzf not installed"; exit 1; }
command -v mpv >/dev/null || { echo "mpv not installed"; exit 1; }
command -v yt-dlp >/dev/null || { echo "yt-dlp not installed"; exit 1; }

while true; do
    clear
    show_home

    read -r -p "Select option: " choice </dev/tty

    case "$choice" in

    #categ
    1)
        category=$(get_categories | fzf \
            --prompt="Category ❯ " \
            --height=100% \
            --border \
            --layout=reverse \
            --cycle \
            --delimiter="|" \
            --with-nth=2)

        [ -z "$category" ] && continue

        cid=$(echo "$category" | awk -F'|' '{print $1}')

        #res
        while true; do
            video=$("$DIR/modules/videos.py" "$cid" | fzf \
                --prompt="Video ❯ " \
                --height=100% \
                --border \
                --layout=reverse \
                --cycle \
                --delimiter="|" \
                --with-nth=2 \
                --preview='echo {} | cut -d"|" -f2' \
                --preview-window=down:4:wrap)

            [ -z "$video" ] && break

            viewkey=$(echo "$video" | awk -F'|' '{print $1}')

            #post menu
            while true; do
                if ! play_video "$viewkey"; then
                    echo "❌ Video unavailable"
                    sleep 1
                    break
                fi

                
                clear
                action=$(post_play_menu)

                case "$action" in
                    1)
                       
                        continue
                        ;;
                    2)
                        break
                        ;;
                    3)
                        nav="home"
                        break
                        ;;
                    q|Q)
                        clear
                        exit 0
                        ;;
                    *)
                        continue
                        ;;
                esac
            done

            #back
            if [ "$nav" = "home" ]; then
                nav=""
                break
            fi
        done
        ;;

    #Search
    2)
        read -r -p "Search query: " query </dev/tty
        [ -z "$query" ] && continue

        while true; do
            video=$("$DIR/modules/search.py" "$query" | fzf \
                --prompt="Search ❯ " \
                --height=100% \
                --border \
                --layout=reverse \
                --cycle \
                --delimiter="|" \
                --with-nth=2 \
                --preview='echo {} | cut -d"|" -f2' \
                --preview-window=down:4:wrap)

            [ -z "$video" ] && break

            viewkey=$(echo "$video" | awk -F'|' '{print $1}')

            while true; do
                if ! play_video "$viewkey"; then
                    echo "❌ Video unavailable"
                    sleep 1
                    break
                fi

                clear
                action=$(post_play_menu)

                case "$action" in
                    1)
                        continue
                        ;;
                    2)
                        break
                        ;;
                    3)
                        nav="home"
                        break
                        ;;
                    q|Q)
                        clear
                        exit 0
                        ;;
                    *)
                        continue
                        ;;
                esac
            done

            if [ "$nav" = "home" ]; then
                nav=""
                break
            fi
        done
        ;;

    #Quit
    q|Q)
        clear
        exit 0
        ;;

    *)
        continue
        ;;
    esac
done
